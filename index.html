<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StarSu | –û–Ω–ª–∞–π–Ω-—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫</title>

    <!-- üîπ –°—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="/public/css/style.css" />
    <link rel="stylesheet" href="/public/css/github-markdown.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
  </head>

  <body>
    <!-- üîπ –•–µ–¥–µ—Ä -->
    <header>
      <h1 class="desktop-title">StarSu | –û–Ω–ª–∞–π–Ω-—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫</h1>
      <h1 class="mobile-title">StarSu | –û–Ω–ª–∞–π–Ω-—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫</h1>
      <button class="menu-toggle">‚ò∞</button>
    </header>

    <!-- üîπ –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é -->
    <div id="overlay" class="overlay"></div>

    <!-- üîπ –õ–µ–≤—ã–π —Å–∞–π–¥–±–∞—Ä (–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è build.js) -->
    <aside class="sidebar" id="sidebar">
      <div class="category open">
        <div class="category-header">
          –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏<span class="arrow">‚ñ≤</span>
        </div>
        <ul class="category-links">
          <li><a href="#classes" data-category="classes">–ö–ª–∞—Å—Å—ã</a></li>
          <li><a href="#races" data-category="races">–†–∞—Å—ã</a></li>
          <li><a href="#skills" data-category="skills">–ù–∞–≤—ã–∫–∏</a></li>
          <li><a href="#feats" data-category="feats">–ß–µ—Ä—Ç—ã</a></li>
          <li><a href="#themes" data-category="themes">–¢–µ–º—ã</a></li>
          <li><a href="#gear" data-category="gear">–°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ</a></li>
          <li><a href="#ships" data-category="ships">–ó–≤–µ–∑–¥–æ–ª—ë—Ç—ã</a></li>
          <li><a href="#magic" data-category="magic">–ú–∞–≥–∏—è –∏ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è</a></li>
          <li><a href="#gear" data-category="gear">–ë–µ—Å—Ç–∏–∞—Ä–∏–π</a></li>
        </ul>
      </div>

      <div class="category open">
        <div class="category-header">–ù–æ–≤–∏—á–∫—É<span class="arrow">‚ñ≤</span></div>
        <ul class="category-links">
          <li>
            <a href="#classes" data-category="classes">–°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</a>
          </li>
          <li>
            <a href="#races" data-category="races">–¢–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞</a>
          </li>
          <li><a href="#Template" data-category="Template">–®–∞–±–ª–æ–Ω</a></li>
        </ul>
      </div>
    </aside>

    <!-- üîπ –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <main>
      <div id="cards" class="cards-grid"></div>
      <div id="content" class="markdown-body"></div>
    </main>

    <!-- üîπ –ü—Ä–∞–≤—ã–π —Å–∞–π–¥–±–∞—Ä (–ø–æ–∫–∞ –ø—É—Å—Ç–æ–π) -->
    <aside class="sidebar right" id="sidebar-right"></aside>

    <script>
      const md = window.markdownit({ html: true, linkify: true });
      let currentCategory = "";
      const allFiles = {
        classes: [
          "–ú–µ—Ö–∞–Ω–∏–∫.md",
          "–ú–∏—Å—Ç–∏–∫.md",
          "–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∏–∫.md",
          "–ü–æ—Å–ª–∞–Ω–Ω–∏–∫.md",
          "–°–æ–ª–¥–∞—Ç.md",
          "–°–æ–ª—è—Ä–∏–æ–Ω.md",
          "–¢–µ—Ö–Ω–æ–º–∞–Ω—Ç.md",
        ],
        races: [
          // –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞—Å—ã
          "–ê–Ω–¥—Ä–æ–∏–¥—ã.md",
          "–í–µ—Å–∫–∏.md",
          "–ì–Ω–æ–º—ã.md",
          "–î–≤–∞—Ä—Ñ—ã.md",
          "–ò—Å–æ–∫–∏.md",
          "–ö–∞—Å–∞—Ç—ã.md",
          "–õ–∞—à—É–Ω—Ç—ã.md",
          "–õ—é–¥–∏.md",
          "–ü–æ–ª—É–æ—Ä–∫–∏.md",
          "–ü–æ–ª—É—Ä–æ—Å–ª–∏–∫–∏.md",
          "–ü–æ–ª—É—ç–ª—å—Ñ—ã.md",
          "–®–∏—Ä—Ä–µ–Ω—ã.md",
          "–≠–ª—å—Ñ—ã.md",
          "–†–∞—Å—ã.md",

          // Starfinder Enhanced
          "–ö–∏—Ü—É–Ω—ç (Starfinder Enhanced).md",

          // Alien Archive
          "–ë–∞—Ä–∞—Ç—É (Alien Archive).md",
          "–í–µ—Ä—Ç–∞–Ω–∏ (Alien Archive).md",
          "–í–∏—á–≤–∏—Ä–¥ (Alien Archive).md",
          "–î—Ä–∞–∫–æ–Ω–æ–∏–¥ (Alien Archive).md",
          "–î—Ä–æ—É (Alien Archive).md",
          "–î—Ä—ç–ª–∏–∫ (Alien Archive).md",
          "–ò–∫–µ—à—Ç–∏ (Alien Archive).md",
          "–ö–∞–ª–æ (Alien Archive).md",
          "–ö–æ—Å–º–æ–≥–æ–±–ª–∏–Ω (Alien Archive).md",
          "–ú–∞—Ä–∞–∫–æ–π (Alien Archive).md",
          "–ù—é–∞—Ä (Alien Archive).md",
          "–†–µ–ø—Ç–∏–ª–æ–∏–¥ (Alien Archive).md",
          "–†–∏–∫—Ä–∏—á–∏ (Alien Archive).md",
          "–†–∏—Ñ–æ—Ä–∏–∞–Ω–∏–Ω (Alien Archive).md",
          "–°–∞—Ä–∫–µ–∑–∏–∞–Ω–∏–Ω (Alien Archive).md",
          "–°–µ—Ä—ã–π –ü—Ä–∏—à–µ–ª–µ—Ü (Alien Archive).md",
          "–£—Ä–æ–≥ (Alien Archive).md",
          "–®–æ–≤–∞–¥ (Alien Archive).md",
        ],
      };

      // –û—á–∏—Å—Ç–∫–∞ –ø—É—Ç–µ–π
      function cleanPath(p) {
        if (!p) return "";
        return decodeURIComponent(
          p.replace(/public\//g, "").replace(/^\//, "")
        );
      }

      // === –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ===
      const menuToggle = document.querySelector(".menu-toggle");
      const sidebar = document.querySelector(".sidebar");
      const overlay = document.getElementById("overlay");

      // === –ó–∞–≥—Ä—É–∑–∫–∞ Markdown ===
      async function loadMarkdown(file) {
        const filePath = cleanPath(file);
        console.log("üìñ –ó–∞–≥—Ä—É–∂–∞–µ–º:", filePath);

        const cards = document.getElementById("cards");
        const content = document.getElementById("content");

        cards.style.display = "none";
        content.classList.add("active");
        content.innerHTML = "<p>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...</p>";

        try {
          const res = await fetch(filePath);
          if (!res.ok) {
            content.innerHTML = "<p style='color:red'>–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω.</p>";
            return;
          }

          const text = await res.text();
          const html = md.render(text);
          content.innerHTML =
            html + '<br><button id="backBtn">‚Üê –ù–∞–∑–∞–¥</button>';

          adjustMobileContent();

          // üîπ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
          document.getElementById("backBtn").onclick = () => {
            content.classList.remove("active");
            content.innerHTML = ""; // –æ—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            cards.style.display = "grid";
            history.pushState("", "", "#" + currentCategory);
            window.scrollTo({ top: 0, behavior: "instant" }); // —Å–±—Ä–æ—Å –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
            adjustMobileContent();
          };
        } catch (err) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:", err);
          content.innerHTML = "<p style='color:red'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞.</p>";
        }
      }

      // === –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ===
      async function loadCategory(category) {
        currentCategory = category;
        const cards = document.getElementById("cards");
        const content = document.getElementById("content");

        cards.style.display = "grid";
        cards.innerHTML =
          "<p style='padding:20px;text-align:center;'>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</p>";
        content.classList.remove("active");

        const files = (allFiles[category] || []).map(
          (f) => `content/guides/${category}/${f}`
        );

        if (!files.length) {
          cards.innerHTML =
            "<p style='padding:20px;'>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤.</p>";
          return;
        }

        cards.innerHTML = files
          .map((f) => {
            const name = decodeURIComponent(
              f.split("/").pop().replace(".md", "")
            );
            const hash = `#${category}/${encodeURIComponent(name)}`;
            return `<div class='card' data-file='${f}' data-hash='${hash}'>
      <h3>${name}</h3>
      <p>Markdown —Ñ–∞–π–ª</p>
    </div>`;
          })
          .join("");
      }

      // === –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ ===
      document.addEventListener("click", async (e) => {
        const cat = e.target.closest("[data-category]");
        const card = e.target.closest("[data-file]");

        // –ö–ª–∏–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        if (cat) {
          e.preventDefault();
          const category = cat.dataset.category;

          // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
          history.pushState("", "", "#" + category);
          await loadCategory(category);

          // üîπ –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —Å—Ç—Ä–∞–Ω–∏—Ü—ã
          const content = document.getElementById("content");
          if (content) {
            content.classList.remove("active");
            content.innerHTML = "";
          }

          window.scrollTo({ top: 0, behavior: "instant" });
          adjustMobileContent();

          // üîπ –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–∞–π–¥–±–∞—Ä–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
          if (window.innerWidth <= 768 && sidebar && overlay) {
            sidebar.classList.remove("active");
            overlay.classList.remove("active");
          }
          return;
        }

        // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ
        if (card) {
          e.preventDefault();
          const file = cleanPath(card.dataset.file);
          const hash = card.dataset.hash;
          history.pushState("", "", hash);
          await loadMarkdown(file);

          // üîπ –¢–∞–∫–∂–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–∞–π–¥–±–∞—Ä
          if (window.innerWidth <= 768 && sidebar && overlay) {
            sidebar.classList.remove("active");
            overlay.classList.remove("active");
          }
        }
      });

      // === –û–±—Ä–∞–±–æ—Ç–∫–∞ —è–∫–æ—Ä–µ–π ===
      async function handleHash() {
        const hash = location.hash.slice(1);
        if (!hash) return;
        const [category, item] = hash.split("/");
        if (!category) return;

        await loadCategory(category);
        if (item) {
          const file = `content/guides/${category}/${decodeURIComponent(
            item
          )}.md`;
          await loadMarkdown(file);
        }
      }

      if (location.hash) handleHash();
      window.addEventListener("hashchange", handleHash);

      // === –ê–∫–∫–æ—Ä–¥–µ–æ–Ω ===
      function initAccordion() {
        document.querySelectorAll(".category-header").forEach((header) => {
          header.addEventListener("click", () => {
            header.closest(".category").classList.toggle("open");
          });
        });
      }
      window.addEventListener("DOMContentLoaded", initAccordion);

      // === –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é ===
      if (menuToggle && sidebar && overlay) {
        menuToggle.addEventListener("click", () => {
          const isActive = sidebar.classList.toggle("active");
          overlay.classList.toggle("active");
          if (isActive) initAccordion();
        });
        overlay.addEventListener("click", () => {
          sidebar.classList.remove("active");
          overlay.classList.remove("active");
        });
      }

      // === –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–æ–¥ —Ö–µ–¥–µ—Ä ===
      function adjustMobileContent() {
        const header = document.querySelector("header");
        const content = document.getElementById("content");
        if (!header || !content) return;

        if (window.innerWidth <= 768) {
          const headerHeight = header.offsetHeight;
          content.style.marginTop = headerHeight + -6 + "px";
        } else {
          content.style.marginTop = "";
        }
      }

      window.addEventListener("resize", adjustMobileContent);
      window.addEventListener("load", adjustMobileContent);
      document.addEventListener("DOMContentLoaded", adjustMobileContent);
    </script>
  </body>
</html>
